{
  "name": "Sistema_Consultas",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ever",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        0,
        0
      ],
      "id": "191a918b-cc83-4b79-a6d8-ab3b8aa7cf44",
      "name": "Webhook",
      "webhookId": "3beefed2-81a6-4097-a2d6-93ee50a2a862"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Eres un empleado del Ã¡rea de calidad y estaras a cargo de redactar procedimientos e instructivos a partir de la implementacion de iso 9001\njson:\n{{ $json.body.message }} \n\nlas respuestas deben estar solo dentro de la llave response, no generen nuevas llaves\n",
        "hasOutputParser": true,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        416,
        0
      ],
      "id": "d02c1622-0182-4b4d-90ee-c3772dd7f4db",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-nano",
          "mode": "list",
          "cachedResultName": "gpt-4.1-nano"
        },
        "responsesApiEnabled": false,
        "options": {
          "responseFormat": "json_object",
          "temperature": 0.4,
          "topP": 0.3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        288,
        208
      ],
      "id": "9fe20951-31df-4e8f-82ca-e01008c5a8cb",
      "name": "OpenAI Chat Model",
      "notesInFlow": false,
      "credentials": {
        "openAiApi": {
          "id": "7D2TxcTctnD2ZM7F",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.output }}\n\n",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        768,
        0
      ],
      "id": "c6ec314c-e6a3-423e-90fd-5c9533ea4b08",
      "name": "Respond to Webhook"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“¦ Format Response - Production Version\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst agentOutput = $input.item.json;\n\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“¥ 1. EXTRAER DATOS DEL WEBHOOK ORIGINAL\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst webhookData = $('Webhook').item.json.body;\nconst originalMessage = webhookData.message || '';\nconst userId = webhookData.user || 'anonymous';\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ”„ 2. EXTRAER RESPUESTA DEL AGENT\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nlet responseText = '';\n\nif (agentOutput.output) {\n  responseText = agentOutput.output;\n  console.log('âœ… Found: agentOutput.output');\n} else if (agentOutput.text) {\n  responseText = agentOutput.text;\n  console.log('âœ… Found: agentOutput.text');\n} else if (agentOutput.response?.generations?.[0]?.[0]?.text) {\n  responseText = agentOutput.response.generations[0][0].text;\n  console.log('âœ… Found: nested response.generations');\n} else {\n  responseText = JSON.stringify(agentOutput);\n  console.warn('âš ï¸ Fallback: using full JSON');\n}\n\nconsole.log('\\nğŸ“ Raw Response Text:', responseText);\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ§¹ 3. LIMPIAR RESPUESTA (remover markdown si existe)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nlet cleanedText = responseText.trim();\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ“Š 4. PARSEAR JSON\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nlet parsedJson = null;\nlet finalResponse = '';\nlet sentiment = 'neutral';\nlet confidence = null;\n\ntry {\n  // Si ya es objeto, usarlo directamente\n  if (typeof cleanedText === 'object') {\n    parsedJson = cleanedText;\n  } else {\n    // Intentar parsear como JSON\n    parsedJson = JSON.parse(cleanedText);\n  }\n  \n  \n  // Extraer campos\n  finalResponse = parsedJson.response || parsedJson.output || parsedJson.text || cleanedText;\n  sentiment = parsedJson.sentiment || 'neutral';\n  confidence = parsedJson.confidence || null;\n  \n} catch (error) {\n  console.error('âŒ JSON Parse Error:', error.message);\n  \n  // Fallback: usar texto plano\n  finalResponse = cleanedText;\n  sentiment = 'unknown';\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ’° 5. EXTRAER TOKEN USAGE (para monitoreo de costos)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst tokenUsage = agentOutput.tokenUsage || \n                   agentOutput.response?.tokenUsage || \n                   null;\n\nlet costEstimate = null;\n\nif (tokenUsage) {\n  // Costos de gpt-4o-mini: $0.15/1M input, $0.60/1M output\n  costEstimate = {\n    inputTokens: tokenUsage.promptTokens || 0,\n    outputTokens: tokenUsage.completionTokens || 0,\n    totalTokens: tokenUsage.totalTokens || 0,\n    estimatedCostUSD: (\n      (tokenUsage.promptTokens || 0) * 0.00000015 +\n      (tokenUsage.completionTokens || 0) * 0.0000006\n    ).toFixed(8)\n  };\n  \n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸ¯ 6. CONSTRUIR RESPUESTA FINAL\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst timestamp = new Date().toISOString();\nconst conversationId = `conv_${userId}_${Date.now()}`; // ğŸ†• Para futuro tracking\n\nconst output = {\n  // âœ… Respuesta principal\n  response: finalResponse,\n  \n  // ğŸ‘¤ Datos del usuario\n  userId: userId,\n  \n  // ğŸ•’ Metadata temporal\n  timestamp: timestamp,\n  conversationId: conversationId,\n  \n  // ğŸ“Š AnÃ¡lisis de sentimiento\n  sentiment: sentiment,\n  confidence: confidence,\n  \n  // ğŸ” Datos originales (Ãºtil para debugging)\n  original: {\n    message: originalMessage,\n    timestamp: timestamp\n  },\n  \n  // ğŸ’° Datos de uso (opcional, comentar si no necesitas)\n  usage: costEstimate\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// ğŸš€ 7. RETORNAR\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nreturn [{\n  json: output\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        176,
        -320
      ],
      "id": "02b8a5aa-539f-439b-915c-c8ca6fe8bdbe",
      "name": "Code in JavaScript"
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        []
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false,
    "timeSavedPerExecution": 1,
    "errorWorkflow": "aGurSLzad9QHqXSa"
  },
  "versionId": "1d479d3b-00ab-4e24-9fa7-c2fcdc3833f5",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "c73792bf178a05aa46c5c68a89c00bd871775266f99c923fb8fb90bf6c936a46"
  },
  "id": "aGurSLzad9QHqXSa",
  "tags": []
}